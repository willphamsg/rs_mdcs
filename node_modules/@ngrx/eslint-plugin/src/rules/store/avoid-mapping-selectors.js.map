{"version":3,"file":"avoid-mapping-selectors.js","sourceRoot":"","sources":["../../../../../../modules/eslint-plugin/src/rules/store/avoid-mapping-selectors.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,2CAA6B;AAC7B,qDAAgD;AAChD,uCAOqB;AAER,QAAA,SAAS,GAAG,wBAAwB,CAAC;AAKlD,kBAAe,IAAA,yBAAU,EAAsB;IAC7C,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC,IAAI;IACjC,IAAI,EAAE;QACJ,IAAI,EAAE,YAAY;QAClB,IAAI,EAAE;YACJ,WAAW,EAAE,iDAAiD;YAC9D,UAAU,EAAE,OAAO;SACpB;QACD,MAAM,EAAE,EAAE;QACV,QAAQ,EAAE;YACR,CAAC,iBAAS,CAAC,EAAE,0CAA0C;SACxD;KACF;IACD,cAAc,EAAE,EAAE;IAClB,MAAM,EAAE,CAAC,OAAO,EAAE,EAAE;QAClB,MAAM,EAAE,WAAW,GAAG,EAAE,EAAE,GAAG,IAAA,qBAAa,EAAC,OAAO,CAAC,CAAC;QACpD,MAAM,UAAU,GAAG,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,IAAA,iBAAS,EAAC,WAAW,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QAE1E,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,MAAM,4BAA4B,GAAG,GAAG,IAAA,sBAAc,EACpD,UAAU,CACX,gFAAyF,CAAC;QAC3F,MAAM,cAAc,GAAG,GAAG,IAAA,+BAAuB,EAC/C,UAAU,CACX,+CAAwD,CAAC;QAE1D,SAAS,gBAAgB,CAAC,IAA6B;YACrD,IAAI,MAAM,GAA8B,IAAI,CAAC,MAAM,CAAC;YACpD,OAAO,MAAM,EAAE,CAAC;gBACd,IACE,IAAA,wBAAgB,EAAC,MAAM,CAAC;oBACxB,IAAA,oBAAY,EAAC,MAAM,CAAC,MAAM,CAAC;oBAC3B,MAAM,CAAC,MAAM,CAAC,IAAI,KAAK,cAAc,EACrC,CAAC;oBACD,OAAO,IAAI,CAAC;gBACd,CAAC;gBACD,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;YACzB,CAAC;YACD,OAAO,KAAK,CAAC;QACf,CAAC;QAED,IAAI,qBAAqB,GAAG,KAAK,CAAC;QAElC,MAAM,aAAa,GAAG,YAAY,cAAc,KAAK,4BAA4B,GAAG,CAAC;QACrF,OAAO;YACL,CAAC,GAAG,aAAa,uCAAuC,CAAC,CACvD,KAA8B;gBAE9B,qBAAqB,GAAG,IAAI,CAAC;YAC/B,CAAC;YACD,CAAC,GAAG,aAAa,kCAAkC,CAAC,CAClD,IAA6B;gBAE7B,IAAI,qBAAqB,EAAE,CAAC;oBAC1B,qBAAqB,GAAG,KAAK,CAAC;oBAC9B,OAAO;gBACT,CAAC;gBAED,IAAI,gBAAgB,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC3B,OAAO;gBACT,CAAC;gBAED,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;gBACjC,MAAM,WAAW,GAAG,SAAS,CAAC,IAAI,CAChC,CAAC,QAAQ,EAAE,EAAE,CACX,IAAA,wBAAgB,EAAC,QAAQ,CAAC;oBAC1B,IAAA,oBAAY,EAAC,QAAQ,CAAC,MAAM,CAAC;oBAC7B,QAAQ,CAAC,MAAM,CAAC,IAAI,KAAK,KAAK,CACjC,CAAC;gBACF,IAAI,WAAW,EAAE,CAAC;oBAChB,OAAO,CAAC,MAAM,CAAC;wBACb,IAAI,EAAE,WAAW;wBACjB,SAAS,EAAT,iBAAS;qBACV,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;SACF,CAAC;IACJ,CAAC;CACF,CAAC,CAAC","sourcesContent":["import type { TSESTree } from '@typescript-eslint/utils';\nimport * as path from 'path';\nimport { createRule } from '../../rule-creator';\nimport {\n  asPattern,\n  getNgRxStores,\n  isCallExpression,\n  isIdentifier,\n  namedCallableExpression,\n  pipeExpression,\n} from '../../utils';\n\nexport const messageId = 'avoidMapppingSelectors';\n\ntype MessageIds = typeof messageId;\ntype Options = readonly [];\n\nexport default createRule<Options, MessageIds>({\n  name: path.parse(__filename).name,\n  meta: {\n    type: 'suggestion',\n    docs: {\n      description: 'Avoid mapping logic outside the selector level.',\n      ngrxModule: 'store',\n    },\n    schema: [],\n    messages: {\n      [messageId]: 'Map logic at the selector level instead.',\n    },\n  },\n  defaultOptions: [],\n  create: (context) => {\n    const { identifiers = [] } = getNgRxStores(context);\n    const storeNames = identifiers.length > 0 ? asPattern(identifiers) : null;\n\n    if (!storeNames) {\n      return {};\n    }\n\n    const pipeWithSelectAndMapSelector = `${pipeExpression(\n      storeNames\n    )}:has(CallExpression[callee.name='select'] ~ CallExpression[callee.name='map'])` as const;\n    const selectSelector = `${namedCallableExpression(\n      storeNames\n    )}[callee.object.callee.property.name='select']` as const;\n\n    function isInCreateEffect(node: TSESTree.CallExpression) {\n      let parent: TSESTree.Node | undefined = node.parent;\n      while (parent) {\n        if (\n          isCallExpression(parent) &&\n          isIdentifier(parent.callee) &&\n          parent.callee.name === 'createEffect'\n        ) {\n          return true;\n        }\n        parent = parent.parent;\n      }\n      return false;\n    }\n\n    let pipeHasThisExpression = false;\n\n    const selectorQuery = `:matches(${selectSelector}, ${pipeWithSelectAndMapSelector})`;\n    return {\n      [`${selectorQuery} > CallExpression:has(ThisExpression)`](\n        _node: TSESTree.CallExpression\n      ) {\n        pipeHasThisExpression = true;\n      },\n      [`${selectorQuery}[callee.property.name=pipe]:exit`](\n        node: TSESTree.CallExpression\n      ) {\n        if (pipeHasThisExpression) {\n          pipeHasThisExpression = false;\n          return;\n        }\n\n        if (isInCreateEffect(node)) {\n          return;\n        }\n\n        const operators = node.arguments;\n        const mapOperator = operators.find(\n          (operator) =>\n            isCallExpression(operator) &&\n            isIdentifier(operator.callee) &&\n            operator.callee.name === 'map'\n        );\n        if (mapOperator) {\n          context.report({\n            node: mapOperator,\n            messageId,\n          });\n        }\n      },\n    };\n  },\n});\n"]}