{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/eslint-plugin/schematics/ng-add/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Rule, SchematicContext, Tree } from '@angular-devkit/schematics';\nimport stripJsonComments from 'strip-json-comments';\nimport type { Schema } from './schema';\nimport * as ts from 'typescript';\n\nexport const possibleFlatConfigPaths = [\n  'eslint.config.js',\n  'eslint.config.mjs',\n  'eslint.config.cjs',\n];\n\nexport default function (schema: Schema): Rule {\n  return (host: Tree, context: SchematicContext) => {\n    const jsonConfigPath = '.eslintrc.json';\n    const flatConfigPath = possibleFlatConfigPaths.find((path) =>\n      host.exists(path)\n    );\n    const docs = 'https://ngrx.io/guide/eslint-plugin';\n\n    if (flatConfigPath) {\n      updateFlatConfig(host, context, flatConfigPath, schema, docs);\n      return host;\n    }\n\n    if (!host.exists(jsonConfigPath)) {\n      context.logger.warn(`\nCould not find an ESLint config at any of ${possibleFlatConfigPaths.join(\n        ', '\n      )} or \\`${jsonConfigPath}\\`.\nThe NgRx ESLint Plugin is installed but not configured.\nPlease see ${docs} to configure the NgRx ESLint Plugin.\n      `);\n      return host;\n    }\n\n    updateJsonConfig(host, context, jsonConfigPath, schema, docs);\n    return host;\n  };\n}\n\nfunction updateFlatConfig(\n  host: Tree,\n  context: SchematicContext,\n  flatConfigPath: string,\n  schema: Schema,\n  docs: string\n): void {\n  const ngrxPlugin = '@ngrx/eslint-plugin/v9';\n  const content = host.read(flatConfigPath)?.toString('utf-8');\n  if (!content) {\n    context.logger.error(\n      `Could not read the ESLint flat config at \\`${flatConfigPath}\\`.`\n    );\n    return;\n  }\n\n  if (content.includes(ngrxPlugin)) {\n    context.logger.info(\n      `Skipping installation, the NgRx ESLint Plugin is already installed in your flat config.`\n    );\n    return;\n  }\n\n  if (!content.includes('tseslint.config')) {\n    context.logger.warn(\n      `No tseslint found, skipping the installation of the NgRx ESLint Plugin in your flat config.`\n    );\n    return;\n  }\n\n  const source = ts.createSourceFile(\n    flatConfigPath,\n    content,\n    ts.ScriptTarget.Latest,\n    true\n  );\n\n  const recorder = host.beginUpdate(flatConfigPath);\n  addImport();\n  addNgRxPlugin();\n\n  host.commitUpdate(recorder);\n  context.logger.info(`\nThe NgRx ESLint Plugin is installed and configured using the '${schema.config}' configuration in your flat config.\nSee ${docs} for more details.\n  `);\n\n  function addImport() {\n    const isESM = content!.includes('export default');\n    if (isESM) {\n      const lastImport = source.statements\n        .filter((statement) => ts.isImportDeclaration(statement))\n        .reverse()[0];\n      recorder.insertRight(\n        lastImport?.end ?? 0,\n        `\\nimport ngrx from '${ngrxPlugin}';`\n      );\n    } else {\n      const lastRequireVariableDeclaration = source.statements\n        .filter((statement) => {\n          if (!ts.isVariableStatement(statement)) return false;\n          const decl = statement.declarationList.declarations[0];\n          if (!decl.initializer) return false;\n          return (\n            ts.isCallExpression(decl.initializer) &&\n            decl.initializer.expression.getText() === 'require'\n          );\n        })\n        .reverse()[0];\n\n      recorder.insertRight(\n        lastRequireVariableDeclaration?.end ?? 0,\n        `\\nconst ngrx = require('${ngrxPlugin}');`\n      );\n    }\n  }\n\n  function addNgRxPlugin() {\n    let tseslintConfigCall: ts.CallExpression | null = null;\n    function findTsEslintConfigCalls(node: ts.Node) {\n      if (tseslintConfigCall) {\n        return;\n      }\n\n      if (\n        ts.isCallExpression(node) &&\n        node.expression.getText() === 'tseslint.config'\n      ) {\n        tseslintConfigCall = node;\n      }\n      ts.forEachChild(node, findTsEslintConfigCalls);\n    }\n    findTsEslintConfigCalls(source);\n\n    if (tseslintConfigCall) {\n      tseslintConfigCall = tseslintConfigCall as ts.CallExpression;\n      const lastArgument =\n        tseslintConfigCall.arguments[tseslintConfigCall.arguments.length - 1];\n      const plugin = `  {\n    files: ['**/*.ts'],\n    extends: [\n      ...ngrx.configs.${schema.config},\n    ],\n    rules: {},\n  }`;\n\n      if (lastArgument) {\n        recorder.remove(lastArgument.pos, lastArgument.end - lastArgument.pos);\n        recorder.insertRight(\n          lastArgument.pos,\n          `${lastArgument.getFullText()},\\n${plugin}`\n        );\n      } else {\n        recorder.insertRight(tseslintConfigCall.end - 1, `\\n${plugin}\\n`);\n      }\n    }\n  }\n}\n\nfunction updateJsonConfig(\n  host: Tree,\n  context: SchematicContext,\n  jsonConfigPath: string,\n  schema: Schema,\n  docs: string\n): void {\n  const eslint = host.read(jsonConfigPath)?.toString('utf-8');\n  if (!eslint) {\n    context.logger.error(`\nCould not find the ESLint config at \\`${jsonConfigPath}\\`.\nThe NgRx ESLint Plugin is installed but not configured.\nPlease see ${docs} to configure the NgRx ESLint Plugin.\n`);\n    return;\n  }\n\n  try {\n    const json = JSON.parse(stripJsonComments(eslint));\n    const plugin = {\n      files: ['*.ts'],\n      extends: [`plugin:@ngrx/${schema.config}`],\n    };\n    if (json.overrides) {\n      if (\n        !json.overrides.some((override: any) =>\n          override.extends?.some((extend: any) =>\n            extend.startsWith('plugin:@ngrx')\n          )\n        )\n      ) {\n        json.overrides.push(plugin);\n      }\n    } else if (\n      !json.extends?.some((extend: any) => extend.startsWith('plugin:@ngrx'))\n    ) {\n      json.overrides = [plugin];\n    }\n\n    host.overwrite(jsonConfigPath, JSON.stringify(json, null, 2));\n\n    context.logger.info(`\nThe NgRx ESLint Plugin is installed and configured with the '${schema.config}' config.\nTake a look at the docs at ${docs} if you want to change the default configuration.\n`);\n  } catch (err) {\n    const detailsContent =\n      err instanceof Error\n        ? `\nDetails:\n${err.message}\n`\n        : '';\n    context.logger.warn(`\nSomething went wrong while adding the NgRx ESLint Plugin.\nThe NgRx ESLint Plugin is installed but not configured.\nPlease see ${docs} to configure the NgRx ESLint Plugin.\n${detailsContent}\n`);\n  }\n}\n"]}